<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Main Infotainment UI</title>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

        <style>
            * { box-sizing: border-box; }

            body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: url("./images/car_dashboard7.jpeg") no-repeat center center;
            background-size: cover;
            }

            .tablet-wrapper {
            width: 90%;
            max-width: 1300px;
            aspect-ratio: 16 / 9;
            background-color: black;
            padding: 20px;
            border-radius: 19px;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            }

            .template {
            background-color: rgb(27, 27, 36);
            border-radius: 20px;
            width: 100%;
            height: 800px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            position: relative;
            }

            .temp-header {
            width: 100%;
            height: 40px;
            font-weight: bold;
            font-size: 28px;
            color: white;
            background-color: black;
            padding-left: 4%;
            position: absolute;
            top: 0;
            }

            .temp-middle {
            height: 89%;
            width: 100%;
            position: absolute;
            top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            }

            /* 왼쪽 검색결과 패널 */
            #results-panel {
            width: 0; /* 기본은 숨김 */
            background: #111;
            color: white;
            overflow-y: auto;
            transition: width 0.3s ease;
            }
            #results-panel.active { 
                width: 30%; 
            }

            #results-panel h3 {
            padding: 10px;
            margin: 0;
            border-bottom: 1px solid #333;
            }

            .result-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            }

            .result-item:hover {
            background: #333;
            }

            #map-container {
            flex: 1;
            position: relative;
            }

            #map {
                width: 100%;
                height: 100%;
                border-radius: 20px;
                filter: invert(90%) hue-rotate(180deg) brightness(1.0) contrast(100%);
            }

            #search-bar {
                position: absolute;
                
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10;
                display: flex;
            }

            #search-input {
                padding:10px; 
                border:none; 
                width:250px;
                background:#000; 
                color:#fff; 
                outline:none;
            }

            #search-input::placeholder { 
                color:#bbb; 
            }

            #search-input:focus { 
                background:#000; 
                color:#fff; 
            }

            #search-button { 
                background:#444; 
                color:#fff; 
                border:none; 
                cursor:pointer; 
            }

            #autocomplete-list {
                position: absolute;
                top: 42px; /* 검색창 아래쪽 */
                left: 0;
                right: 0;
                background: #222;
                border: 1px solid #444;
                z-index: 20;
                max-height: 200px;
                overflow-y: auto;
                border-radius: 5px;
            }

            .autocomplete-item {
                padding: 8px;
                cursor: pointer;
                color: #fff;
            }

            .autocomplete-item:hover {
                background: #444;
            }

            .temp-footer {
            width: 100%;
            height: 50px;
            background-color: black;
            position:absolute;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            }

            .temp-footer-left {
            width: 30%;
            height: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding-left: 3%;
            }
            .temp-footer-left img {
            max-width: 18%;
            max-height: 18%;
            object-fit: contain;
            }

            .temp-footer-right {
            width: 70%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 200px;
            }
            .temp-footer-right img {
            width: 35%;
            height: 35%;
            object-fit: contain;
            }
        </style>
    </head>
    <body>
    <div class ="tablet-wrapper">
        <div class="template">
        <div class="temp-header">SSAFY</div>

        <div class="temp-middle">
            <div id="results-panel">
            <h3>검색 결과</h3>
            <div id="results"></div>
            </div>

            <!-- 지도 -->
            <div id="map-container">
            <div id="map"></div>
            <div id="search-bar">
                <input id="search-input" placeholder="검색할 장소 입력" type="text" autocomplete='off'>
                <button id="search-button">검색</button>
                <div id="autocomplete-list"></div>
            </div>
            </div>
        </div>

        <div class="temp-footer">
            <div class="temp-footer-left">
            <a href="main.html">
                <img src="./images/car.svg" alt="자동차">
            </a>
            </div>
            <div class="temp-footer-right">
            <a href="./navigation.html"><img src="./images/navi.svg" alt="navi"></a>
            <a href="main.html"><img src="./images/bright.svg" alt="Weather"></a>
            <a href="main.html"><img src="./images/equalize.svg" alt="Switch User"></a>
            <a href="main.html"><img src="./images/chat.svg" alt="chat"></a>
            <a href="./portfolio.html"><img src="./images/mypage.svg" alt="My Page"></a>
            <a href="main.html"><img src="./images/setting.svg" alt="Setting"></a>
            </div>
        </div>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=fb54ceb011e20dafd865054255e57625&libraries=services"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
        const mapContainer = document.getElementById("map");
        const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 5,
        });

        const places = new kakao.maps.services.Places();
        let markers = [];

        const searchButton = document.getElementById("search-button");
        const searchInput = document.getElementById("search-input");
        const autocompleteList = document.getElementById("autocomplete-list");
        const resultsPanel = document.getElementById("results-panel");
        const resultsDiv = document.getElementById("results");

        let myPosition = null;       // 내 위치 LatLng 저장
        let myMarker = null;         // 내 위치 마커
        let destMarker = null;       // 목적지 마커
        let polyline = null;         // 경로 Polyline

        // 내 위치 마커 표시
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                myPosition = new kakao.maps.LatLng(lat, lng);

                // 자동차 이미지 마커 생성
                const carImageSrc = "./images/car_marker.png";  // 자동차 아이콘 이미지 경로
                const carImageSize = new kakao.maps.Size(48, 48); // 아이콘 크기
                const carImageOption = { offset: new kakao.maps.Point(24, 48) }; // 중심 좌표 보정
                const carMarkerImage = new kakao.maps.MarkerImage(carImageSrc, carImageSize, carImageOption);

                myMarker = new kakao.maps.Marker({
                    position: myPosition,
                    map: map,
                    title: "내 위치",
                    image: carMarkerImage
                });

                map.setCenter(myPosition);
            });
        }


        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
        }

        function displayPlaces(placesData) {
            resultsDiv.innerHTML = "";
            clearMarkers();

            if (!placesData.length) {
            resultsDiv.innerHTML = "<p style='padding:10px;'>검색 결과가 없습니다.</p>";
            return;
            }
            
            // 패널 보이기
            resultsPanel.classList.add("active");

            const bounds = new kakao.maps.LatLngBounds();

            placesData.forEach((place) => {
            const position = new kakao.maps.LatLng(place.y, place.x);

            const marker = new kakao.maps.Marker({
                map,
                position: position
            });

            markers.push(marker);
            bounds.extend(position);

            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `<b>${place.place_name}</b><br>${place.address_name}`;

            div.onclick = () => {
                // 다른 마커들 제거
                clearMarkers();

                // 이전 목적지 마커 제거 및 경로 제거
                if (destMarker) destMarker.setMap(null);
                if (polyline) polyline.setMap(null);

                const destLatLng = new kakao.maps.LatLng(place.y, place.x);

                // 선택한 목적지만 표시
                destMarker = new kakao.maps.Marker({
                    position: destLatLng,
                    map: map,
                    title: place.place_name
                });

                map.panTo(destLatLng);

                // 내 위치에서 목적지까지 경로 표시
                if (myPosition) {
                axios.get("https://apis-navi.kakaomobility.com/v1/directions", {
                    headers: {
                    Authorization: "KakaoAK e9b46712fc4c4cfe4ba4686c3bf69b25"
                    },
                    params: {
                    origin: `${myPosition.getLng()},${myPosition.getLat()}`,
                    destination: `${place.x},${place.y}`
                    }
                }).then(res => {
                    const route = res.data.routes[0].sections[0].roads;
                    const path = [];

                    route.forEach(road => {
                    for (let i = 0; i < road.vertexes.length; i += 2) {
                        const lng = road.vertexes[i];
                        const lat = road.vertexes[i + 1];
                        path.push(new kakao.maps.LatLng(lat, lng));
                    }
                    });

                    polyline = new kakao.maps.Polyline({
                        map,
                        path,
                        strokeWeight: 8,
                        strokeColor: "#000000",
                        strokeOpacity: 1,
                        strokeStyle: "solid"
                    });

                    const bounds = new kakao.maps.LatLngBounds();
                    path.forEach(p => bounds.extend(p));
                    map.setBounds(bounds);
                });
                }
            };
            resultsDiv.appendChild(div);
            });

            map.setBounds(bounds);
        }

        // 검색 함수
        function doSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) return alert("검색어를 입력하세요");

            saveSearchHistory(keyword);
            autocompleteList.innerHTML = "";

            // 새 검색 시작 전에 목적지/경로 초기화
            if (destMarker) { 
                destMarker.setMap(null); 
                destMarker = null; 
            }
            if (polyline) { 
                polyline.setMap(null);   
                polyline = null; 
            }

            places.keywordSearch(keyword, (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    displayPlaces(data);
                } else {
                    resultsDiv.innerHTML = "<p style='padding:10px;'>검색 결과가 없습니다.</p>";
                    resultsPanel.classList.add("active");
                }
            });
        }

        function saveSearchHistory(keyword) {
            let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
            if (!history.includes(keyword)) {
                history.unshift(keyword); // 최근 검색어 맨 앞
                if (history.length > 10) history.pop(); // 최대 10개 유지
                localStorage.setItem("searchHistory", JSON.stringify(history));
            }
        }

        function showAutocomplete(value) {
            autocompleteList.innerHTML = "";
            if (!value) return;

            let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
            let filtered = history.filter(item => item.includes(value));

            filtered.forEach(item => {
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.innerText = item;
                div.onclick = () => {
                    searchInput.value = item;
                    autocompleteList.innerHTML = "";
                    doSearch(); // 선택 시 바로 검색 실행
                };
                autocompleteList.appendChild(div);
            });
        }

        // 입력할 때 자동완성 갱신
        searchInput.addEventListener("input", () => {
            showAutocomplete(searchInput.value.trim());
        });

        searchButton.onclick = doSearch;
        searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") doSearch();
        });
        </script>

    </body>
</html>
